name: Update Bibliography

on:
  push:
    paths:
      - '**.bib'
  workflow_dispatch:
    inputs:
      bib_file:
        description: 'Specific .bib file to process (leave empty for all changed)'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  update-bib:
    runs-on: ubuntu-latest
    # Don't run on commits made by this action to avoid loops
    if: github.actor != 'github-actions[bot]'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need HEAD~1 for diff

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install bibtexupdater
        run: |
          pip install bibtexparser requests crossref-commons httpx rapidfuzz

      - name: Verify bibtexupdater script exists
        run: |
          # Script is part of this repo - no need to download
          if [ ! -f bibtex_updater.py ]; then
            echo "ERROR: bibtex_updater.py not found in repository"
            exit 1
          fi
          echo "Script found in repository"

      - name: Find .bib files to process
        id: find-bib
        run: |
          if [ -n "${{ github.event.inputs.bib_file }}" ]; then
            # Manual trigger with specific file
            echo "files=${{ github.event.inputs.bib_file }}" >> $GITHUB_OUTPUT
          else
            # Auto-trigger: find changed .bib files
            changed=$(git diff --name-only HEAD~1 HEAD -- '*.bib' 2>/dev/null | tr '\n' ' ' || echo "")
            if [ -z "$changed" ]; then
              echo "No .bib files changed"
              echo "files=" >> $GITHUB_OUTPUT
            else
              echo "Changed .bib files: $changed"
              echo "files=$changed" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Update bibliography references
        if: steps.find-bib.outputs.files != ''
        run: |
          for bib in ${{ steps.find-bib.outputs.files }}; do
            if [ -f "$bib" ]; then
              echo "::group::Processing $bib"
              python bibtex_updater.py "$bib" --in-place --dedupe --verbose || echo "Warning: Some entries may have failed to update"
              echo "::endgroup::"
            fi
          done

      - name: Check for changes
        id: check-changes
        run: |
          if git diff --quiet; then
            echo "No changes detected"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected:"
            git diff --stat
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.check-changes.outputs.changed == 'true'
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore: auto-update bibliography references

          Preprint entries upgraded to published versions where available.

          ðŸ¤– Generated by bibtexupdater GitHub Action"
          git push
