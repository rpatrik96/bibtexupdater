name: Update and Filter Bibliography

on:
  push:
    paths:
      - '**.bib'
      - '**.tex'
  workflow_dispatch:
    inputs:
      bib_file:
        description: 'Path to .bib file (leave empty for auto-detect)'
        required: false
        default: ''
      tex_dir:
        description: 'Directory containing .tex files (leave empty for auto-detect)'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  update-filter-bib:
    runs-on: ubuntu-latest
    # Don't run on commits made by this action to avoid loops
    if: github.actor != 'github-actions[bot]'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install bibtexparser requests crossref-commons httpx rapidfuzz

      - name: Verify bibtexupdater scripts exist
        run: |
          # Scripts are part of this repo - no need to download
          if [ ! -f bibtex_updater.py ]; then
            echo "ERROR: bibtex_updater.py not found in repository"
            exit 1
          fi
          if [ ! -f filter_bibliography.py ]; then
            echo "ERROR: filter_bibliography.py not found in repository"
            exit 1
          fi
          echo "Scripts found in repository"

      - name: Find .bib and .tex files
        id: find-files
        run: |
          # Determine .bib file
          if [ -n "${{ github.event.inputs.bib_file }}" ]; then
            bib="${{ github.event.inputs.bib_file }}"
          else
            # Auto-detect: prefer common names, then any .bib
            bib=$(find . -maxdepth 2 -name "references.bib" -type f 2>/dev/null | head -1)
            [ -z "$bib" ] && bib=$(find . -maxdepth 2 -name "bibliography.bib" -type f 2>/dev/null | head -1)
            [ -z "$bib" ] && bib=$(find . -maxdepth 2 -name "*.bib" -type f 2>/dev/null | head -1)
          fi
          echo "bib=$bib" >> $GITHUB_OUTPUT
          echo "Found .bib file: $bib"

          # Determine .tex directory
          if [ -n "${{ github.event.inputs.tex_dir }}" ]; then
            tex_dir="${{ github.event.inputs.tex_dir }}"
          else
            # Auto-detect: find directory with main.tex or any .tex
            tex=$(find . -maxdepth 2 -name "main.tex" -type f 2>/dev/null | head -1)
            [ -z "$tex" ] && tex=$(find . -maxdepth 2 -name "*.tex" -type f 2>/dev/null | head -1)
            tex_dir=$(dirname "$tex" 2>/dev/null || echo ".")
          fi
          echo "tex_dir=$tex_dir" >> $GITHUB_OUTPUT
          echo "Found .tex directory: $tex_dir"

      - name: Update preprint references
        if: steps.find-files.outputs.bib != ''
        run: |
          echo "::group::Updating preprint references in ${{ steps.find-files.outputs.bib }}"
          python bibtex_updater.py "${{ steps.find-files.outputs.bib }}" \
            --in-place --dedupe --verbose || echo "Warning: Some entries may have failed to update"
          echo "::endgroup::"

      - name: Filter to cited entries only
        if: steps.find-files.outputs.bib != '' && steps.find-files.outputs.tex_dir != ''
        run: |
          echo "::group::Filtering to cited entries"
          # Check if filter_bibliography supports the expected arguments
          python filter_bibliography.py \
            "${{ steps.find-files.outputs.bib }}" \
            "${{ steps.find-files.outputs.tex_dir }}" \
            --output "${{ steps.find-files.outputs.bib }}" \
            --recursive || echo "Warning: Filtering may have encountered issues"
          echo "::endgroup::"

      - name: Check for changes
        id: check-changes
        run: |
          if git diff --quiet; then
            echo "No changes detected"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected:"
            git diff --stat
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.check-changes.outputs.changed == 'true'
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore: update and filter bibliography

          - Preprint entries upgraded to published versions
          - Filtered to only cited entries

          ðŸ¤– Generated by bibtexupdater GitHub Action"
          git push
