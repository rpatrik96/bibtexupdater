name: Reusable BibTeX Update

on:
  workflow_call:
    inputs:
      bib_files:
        type: string
        default: '*.bib'
        description: 'Space-separated list of .bib files or glob pattern'
      dedupe:
        type: boolean
        default: true
        description: 'Remove duplicate entries'
      keep_preprint_note:
        type: boolean
        default: false
        description: 'Keep arXiv ID in note field after upgrade'
      verbose:
        type: boolean
        default: false
        description: 'Enable verbose logging'

jobs:
  update-bibliography:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install bibtexparser requests crossref-commons httpx rapidfuzz

      - name: Download bibtexupdater
        run: |
          curl -sL https://raw.githubusercontent.com/rpatrik96/bibtexupdater/main/bibtex_updater.py -o bibtex_updater.py

      - name: Process bibliography files
        run: |
          # Build command options
          opts="--in-place"
          ${{ inputs.dedupe }} && opts="$opts --dedupe"
          ${{ inputs.keep_preprint_note }} && opts="$opts --keep-preprint-note"
          ${{ inputs.verbose }} && opts="$opts --verbose"

          # Process each file
          for pattern in ${{ inputs.bib_files }}; do
            for bib in $pattern; do
              if [ -f "$bib" ]; then
                echo "Processing: $bib"
                python bibtex_updater.py "$bib" $opts || echo "Warning: $bib may have had issues"
              fi
            done
          done

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: |
            chore: auto-update bibliography references

            Preprint entries upgraded to published versions where available.

            ðŸ¤– Generated by bibtexupdater
          file_pattern: '*.bib'
